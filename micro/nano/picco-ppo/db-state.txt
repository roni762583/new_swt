DATABASE STATE REPORT - COMPLETE SCHEMA WITH FORMULAS
Generated on: 2025-10-03 16:52 (Updated - Added 3 columns: pretrain_action, rsi_extreme, bb_position)


================================================================================
DATABASE: /home/aharon/projects/new_swt/micro/nano/picco-ppo/master.duckdb
================================================================================
Tables found: 1

============================================================
TABLE: master
============================================================
Row count: 1,333,912
Column count: 66

Full column listing with formulas:
------------------------------------------------------------
   1. timestamp                 TIMESTAMP    Bar timestamp (PRIMARY KEY)
   2. bar_index                 BIGINT       Sequential bar number
   3. open                      DOUBLE       M1 bar open price
   4. high                      DOUBLE       M1 bar high price
   5. low                       DOUBLE       M1 bar low price
   6. close                     DOUBLE       M1 bar close price
   7. volume                    BIGINT       M1 bar volume
   8. swing_high_m1             BOOLEAN      True if M1 swing high (h[i] > h[i-1] and h[i] > h[i+1])
   9. swing_low_m1              BOOLEAN      True if M1 swing low (l[i] < l[i-1] and l[i] < l[i+1])
  10. swing_high_h1             BOOLEAN      True if H1 swing high (highest M1 swing high in hour)
  11. swing_low_h1              BOOLEAN      True if H1 swing low (lowest M1 swing low in hour)
  12. last_m1_hsp_idx           BIGINT       Bar index of last M1 high swing point (hsp = high swing point)
  13. last_m1_hsp_val           DOUBLE       Price value of last M1 high swing point
  14. prev_m1_hsp_idx           BIGINT       Bar index of previous M1 high swing point
  15. prev_m1_hsp_val           DOUBLE       Price value of previous M1 high swing point
  16. last_m1_lsp_idx           BIGINT       Bar index of last M1 low swing point (lsp = low swing point)
  17. last_m1_lsp_val           DOUBLE       Price value of last M1 low swing point
  18. prev_m1_lsp_idx           BIGINT       Bar index of previous M1 low swing point
  19. prev_m1_lsp_val           DOUBLE       Price value of previous M1 low swing point
  20. last_h1_hsp_idx           BIGINT       Bar index of last H1 high swing point
  21. last_h1_hsp_val           DOUBLE       Price value of last H1 high swing point
  22. prev_h1_hsp_idx           BIGINT       Bar index of previous H1 high swing point
  23. prev_h1_hsp_val           DOUBLE       Price value of previous H1 high swing point
  24. last_h1_lsp_idx           BIGINT       Bar index of last H1 low swing point
  25. last_h1_lsp_val           DOUBLE       Price value of last H1 low swing point
  26. prev_h1_lsp_idx           BIGINT       Bar index of previous H1 low swing point
  27. prev_h1_lsp_val           DOUBLE       Price value of previous H1 low swing point
  28. h1_swing_range_position   DOUBLE       (close - last_h1_lsp_val) / (last_h1_hsp_val - last_h1_lsp_val)
                                              Range [0, 1] where 0=at swing low, 1=at swing high
  29. swing_point_range         DOUBLE       last_h1_hsp_val - last_h1_lsp_val
                                              H1 swing range magnitude in price units
  30. h1_swing_range_position_zsarctan_w20 DOUBLE  arctan((h1_swing_range_position - rolling_mean_20) / fixed_std) * 2/π
                                              Window=20, Fixed std=3.421357 (923,116 training rows)
                                              Detects short-term position extremes within H1 range
  31. swing_point_range_zsarctan_w20 DOUBLE   arctan((swing_point_range - rolling_mean_20) / fixed_std) * 2/π
                                              Window=20, Fixed std=0.221478 (933,724 training rows)
                                              Detects when H1 range itself is extreme (tight/wide)
  32. high_swing_slope_h1       DOUBLE       (current_h1_swing_high - previous_h1_swing_high) / (time_diff_bars)
                                              Rate of change between consecutive H1 swing highs (pips/bar)
                                              Forward-filled from each swing high until next
                                              Mean: -0.012 pips/bar, Range: [-11.68, +63.00]
  33. low_swing_slope_h1        DOUBLE       (current_h1_swing_low - previous_h1_swing_low) / (time_diff_bars)
                                              Rate of change between consecutive H1 swing lows (pips/bar)
                                              Forward-filled from each swing low until next
                                              Mean: +0.019 pips/bar, Range: [-91.50, +23.93]
  34. high_swing_slope_h1_zsarctan DOUBLE    arctan((high_swing_slope_h1 - rolling_mean_20) / fixed_std) * 2/π
                                              Window=20, Fixed std=0.619729 (933,705 training rows)
                                              Detects extreme uptrends/downtrends in swing highs
                                              Mean: +0.0016, Range: [-0.9936, +0.9934]
                                              Extremes (|z|>0.8): 3,782 (0.28%)
  35. low_swing_slope_h1_zsarctan DOUBLE     arctan((low_swing_slope_h1 - rolling_mean_20) / fixed_std) * 2/π
                                              Window=20, Fixed std=1.341183 (933,653 training rows)
                                              Detects extreme uptrends/downtrends in swing lows
                                              Mean: -0.0007, Range: [-0.9901, +0.9904]
                                              Extremes (|z|>0.8): 1,053 (0.08%)
  36. combo_geometric           DOUBLE       sign(r×p) × sqrt(|range_z| × |position_z|)
                                              Geometric mean interaction: penalizes imbalance, favors balanced extremes
                                              Superior to arithmetic multiply: Avg |corr|=0.077 vs 0.046 (+69%)
                                              Formula: GM = sign(r×p) × sqrt(|r| × |p|) where r=range_z, p=position_z
                                              Strong signals (|z|>0.5): 7,828 events (0.60%)
                                              Quadrant predictive power (5-min):
                                                Q2 (big range, small pos): Corr=+0.184 (strongest!)
                                                Q1 (both big): Corr=+0.104
                                                Q3 (small range, big pos): Corr=-0.062 (reversal signal)
  37. high_swing_slope_m1       DOUBLE       M1 high swing slope (rate of change, pips/bar)
  38. low_swing_slope_m1        DOUBLE       M1 low swing slope (rate of change, pips/bar)
  39. h1_trend_slope            DOUBLE       H1 market structure based slope selection:
                                              HHHL (Higher Highs, Higher Lows) = low_swing_slope_h1_zsarctan
                                              LHLL (Lower Highs, Lower Lows) = high_swing_slope_h1_zsarctan
                                              Divergence (HHLL or LHHL) = average of both slopes
                                              Intelligently selects relevant slope based on current trend structure
  40. log_return_1m             DOUBLE       LN(close / close_1bar_ago)
                                              1-minute log return for momentum detection
                                              Valid: 1,333,911 (100.0%), Range: [-0.018, +0.011]
  41. log_return_5m             DOUBLE       LN(close / close_5bars_ago)
                                              5-minute log return for short-term trend
                                              Valid: 1,333,907 (100.0%), Range: [-0.031, +0.017]
  42. log_return_60m            DOUBLE       LN(close / close_60bars_ago)
                                              H1 log return for longer-term trend alignment
                                              Valid: 1,333,852 (100.0%), Range: [-0.039, +0.023]
  43. efficiency_ratio_h1       DOUBLE       abs(close - close.shift(60)) / close.diff().abs().rolling(60).sum()
                                              H1 efficiency ratio: directional movement vs path length
                                              Range [0, 1]: 0=choppy (random walk), 1=trending (straight line)
                                              Valid: 1,333,852 (100.0%), Mean: 0.124, Range: [0.000, 0.784]
  44. zigzag_price              DOUBLE       ZigZag indicator swing points (NaN elsewhere)
                                              Min swing: 10 pips (0.10 price units for GBPJPY)
                                              Pivots: 55,807 (4.18% of bars)
                                              Avg swing: 24.4 pips, Range: [10.0, 513.4] pips
                                              For pretraining labels and major turning point detection
  45. zigzag_direction          TINYINT      ZigZag trend direction at each bar
                                              +1 = uptrend, -1 = downtrend, 0 = undefined
                                              Uptrend: 699,832 bars (52.46%)
                                              Downtrend: 634,066 bars (47.53%)
                                              Trend reversals: 10,348 events
  46. is_zigzag_pivot           BOOLEAN      True at ZigZag swing points, False elsewhere
                                              Marks major market turning points (55,807 pivots)
                                              Use for supervised learning labels
  47. atr_60                    DOUBLE       Average True Range (60 M1 bars = 1 hour volatility context)
                                              TR = max(high-low, |high-prev_close|, |low-prev_close|)
                                              ATR = TR.rolling(60).mean()
                                              Mean: 3.90 pips, Range: [0.4, 46.7] pips
                                              CRITICAL for position sizing and risk management
  48. atr_14                    DOUBLE       Average True Range (14 M1 bars = short-term volatility)
                                              Mean: 3.90 pips, Range: [0.1, 97.2] pips
                                              Use for adaptive stop placement (2-3x ATR)
                                              Flash crash peak: 56.6 pips (5.0x increase from baseline)
  49. momentum_strength_3       DOUBLE       3-bar cumulative log returns (lr_1m.rolling(3).sum())
                                              Detects momentum acceleration/deceleration
                                              Range: [-279 pips, +127 pips] cumulative
                                              Flash crash extreme: -279 pips (massive acceleration)
                                              Extreme signals (|z|>99th percentile): 1% of bars
  50. momentum_strength_10      DOUBLE       10-bar cumulative log returns (lr_1m.rolling(10).sum())
                                              Detects medium-term momentum persistence
                                              Range: [-322 pips, +155 pips] cumulative
                                              Flash crash extreme: -322 pips (trend exhaustion warning)
                                              Use to avoid fighting strong trends
  51. realized_vol_20           DOUBLE       Realized volatility (rolling std of lr_1m over 20 bars)
                                              Measures actual return dispersion (20 minutes)
                                              Mean: 0.00015, Range: [0.000009, 0.005428]
                                              Flash crash peak: 0.00429 (8.8x increase)
                                              Different from ATR: rvol = return variance, ATR = range
  52. realized_vol_60           DOUBLE       Realized volatility (rolling std of lr_1m over 60 bars)
                                              Measures hourly return dispersion (1 hour)
                                              Mean: 0.00016, Range: [0.000021, 0.003337]
                                              Flash crash peak: 0.00259 (6.3x increase)
                                              Use for volatility regime detection
  53. vol_ratio                 DOUBLE       Volatility ratio (realized_vol_20 / realized_vol_60)
                                              Detects short-term vs long-term volatility changes
                                              Mean: 0.98, Range: [0.08, 1.75]
                                              >1.5 = volatility spike (reduce position size)
                                              <0.7 = compression (9.3% of bars, breakout potential)
                                              Normal regime (0.7-1.3): 83.4% of bars
  54. atr_60_zsarctan_w20       DOUBLE       arctan((atr_60 - rolling_mean_20) / fixed_std) * 2/π
                                              Window=20, Fixed std=0.020560 (933,737 training rows)
                                              Hourly ATR regime detection vs 20-bar baseline
                                              Mean: -0.000476, Range: [-0.8938, +0.9061]
                                              Extremes (|z|>0.8): 258 (0.02% of bars)
  55. atr_14_zsarctan_w20       DOUBLE       arctan((atr_14 - rolling_mean_20) / fixed_std) * 2/π
                                              Window=20, Fixed std=0.023129 (933,737 training rows)
                                              Short-term ATR regime detection vs 20-bar baseline
                                              Mean: -0.004305, Range: [-0.9565, +0.9729]
                                              Extremes (|z|>0.8): 2,594 (0.19% of bars)
                                              Flash crash: 6/7 bars had |z|>0.8 (extreme volatility)
  56. momentum_strength_10_zsarctan_w20 DOUBLE arctan((momentum_strength_10 - rolling_mean_20) / fixed_std) * 2/π
                                              Window=20, Fixed std=0.000559 (933,737 training rows)
                                              10-bar momentum extreme detection
                                              Mean: -0.000589, Range: [-0.9858, +0.9840]
                                              Extremes (|z|>0.8): 14,403 (1.08% of bars)
                                              Flash crash: 5/7 bars had |z|>0.8 (momentum persistence)
  57. realized_vol_20_zsarctan_w20 DOUBLE    arctan((realized_vol_20 - rolling_mean_20) / fixed_std) * 2/π
                                              Window=20, Fixed std=0.000106 (933,733 training rows)
                                              Short-term realized volatility regime detection
                                              Mean: -0.001875, Range: [-0.9765, +0.9808]
                                              Extremes (|z|>0.8): 3,400 (0.25% of bars)
                                              Flash crash: 6/7 bars had |z|>0.8 (volatility spike)
  58. realized_vol_60_zsarctan_w20 DOUBLE    arctan((realized_vol_60 - rolling_mean_20) / fixed_std) * 2/π
                                              Window=20, Fixed std=0.000099 (933,728 training rows)
                                              Hourly realized volatility regime detection
                                              Mean: -0.000864, Range: [-0.9574, +0.9678]
                                              Extremes (|z|>0.8): 958 (0.07% of bars)
  59. vol_ratio_deviation       DOUBLE       vol_ratio - 1.0 (centered around 0)
                                              Negative = compression (short-term < long-term)
                                              Positive = spike (short-term > long-term)
                                              Mean: -0.023, Range: [-0.915, +0.754]
                                              <-0.3: Compression (9% of bars)
                                              -0.3 to +0.3: Normal (83% of bars)
                                              >+0.5: Spike (7% of bars)
                                              Flash crash: All 7 bars had dev>0.5 (consistent spike)
                                              NO z-score applied (ratio already normalized)
  60. hour_sin                  DOUBLE       sin(2π × hour / 24)
                                              24-hour timecycle encoding
                                              Mean: 0.006518, Range: [-1.0, +1.0]
                                              Captures intraday patterns
  61. hour_cos                  DOUBLE       cos(2π × hour / 24)
                                              24-hour timecycle encoding (orthogonal to hour_sin)
                                              Mean: 0.001893, Range: [-1.0, +1.0]
  62. dow_sin                   DOUBLE       sin(2π × day_of_week / 5)
                                              5-day trading week timecycle (Mon-Fri)
                                              Mean: 0.108712, Range: [-0.951, +0.951]
                                              Captures weekly patterns
  63. dow_cos                   DOUBLE       cos(2π × day_of_week / 5)
                                              5-day trading week timecycle (orthogonal to dow_sin)
                                              Mean: -0.001256, Range: [-0.809, +1.0]
  64. pretrain_action           TINYINT      ZigZag-based pretraining labels
                                              0=HOLD (92.06%), 1=BUY (2.11%), 2=SELL (2.07%), 3=CLOSE (3.76%)
                                              Entry: 2 bars after pivot confirmation
                                              Exit: Bar before next pivot
                                              Total trades: 55,807
  65. rsi_extreme               DOUBLE       (RSI14 - 50) / 50, bounded [-1, 1]
                                              Normalized RSI oscillator for overbought/oversold detection
                                              Mean: 0.0072, Range: [-0.936, +0.940]
                                              Extremes (|x|>0.8): 262 (0.02%)
  66. bb_position               DOUBLE       (close - sma20) / (2 * std20), clipped [-2, 2]
                                              Bollinger Band position indicator
                                              Mean: 0.0142, Range: [-2.0, +2.0]
                                              Distribution: >+1.0: 5.20%, -1 to +1: 89.64%, <-1.0: 5.16%

File size: 335.54 MB (last modified: 2025-10-03 16:51)



● ✅ Merged all feature generation into generate_all_features.py:

  Added to the script:
  - Step 0: ZigZag indicator (30 pips minimum)
  - Step 9: RSI extreme
  - Step 10: BB position
  - Deleted add_pretrain_and_indicators.py and update_zigzag_30pips.py

  Consolidated feature generation order:
  1. ZigZag (30 pips)
  2. Swing points (M1/H1)
  3. Last swing tracking
  4. H1 swing range position
  5. Swing point range
  6. Swing slopes
  7. Z-score features
  8. H1 trend slope
  9. Pretrain action
  10. RSI extreme
  11. BB position
  12. M1 trend slope

  All in one script as per CLAUDE.md guidelines.